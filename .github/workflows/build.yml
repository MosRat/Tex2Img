name: Build and Release

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release draft (true/false)'
        required: false
        default: 'false'

permissions:
  contents: write  # 允许创建 release 和上传资产

env:
  CARGO_TERM_COLOR: always
  # RUSTFLAGS: '-Ctarget-feature=+crt-static'  # Windows only, set globally and filtered by platform

jobs:
  build:
    strategy:
      matrix:
        platform:
          - os: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
            pdfium_url: https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-linux-x64.tgz
            pdfium_lib: lib/libpdfium.so
            artifact_name: tex2img-linux-x64
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   pdfium_url: https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-x64.tgz
          #   pdfium_lib: lib/libpdfium.dylib
          #   artifact_name: tex2img-macos-x64
          # - os: macos-latest
          #   target: aarch64-apple-darwin
          #   pdfium_url: https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-arm64.tgz
          #   pdfium_lib: lib/libpdfium.dylib
          #   artifact_name: tex2img-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            pdfium_url: https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz
            pdfium_lib: bin/pdfium.dll
            artifact_name: tex2img-windows-x64

    runs-on: ${{ matrix.platform.os }}

    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 安装 Rust
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}
      - name : Init Rust
        run: |
          rustup update
          rustup toolchain install stable
          rustup default stable

      # 安装 vcpkg 依赖（Linux）
      - name: Install vcpkg dependencies (Linux)
        if: matrix.platform.os == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl zip unzip tar pkg-config libssl-dev uuid-dev autoconf automake autoconf-archive libfontconfig1-dev libgraphite2-dev libharfbuzz-dev libicu-dev zlib1g-dev



      # 安装 vcpkg 依赖（macOS）
      - name: Install vcpkg dependencies (macOS)
        if: contains(matrix.platform.os, 'macos')
        run: |
          brew install pkg-config
          sudo xcode-select --install || true

      # - name: Install MSVC (Windows)
      #   if: matrix.platform.os == 'windows-latest'
      #   uses: ilammy/msvc-dev-cmd@v1

      # 安装 vcpkg
      # - name: Install vcpkg
      #   run: |
      #     git clone https://github.com/microsoft/vcpkg.git ./vcpkg
      #     ./vcpkg/bootstrap-vcpkg.sh -disableMetrics

      # 运行 cargo-vcpkg
      - name: Build vcpkg dependencies
        if: matrix.platform.os == 'windows-latest'
        run: |

          git clone https://github.com/microsoft/vcpkg.git "$env:USERPROFILE\.vcpkg"
          echo "VCPKG_ROOT=$env:USERPROFILE\.vcpkg" >> $env:GITHUB_ENV
          cargo install cargo-vcpkg
          cargo vcpkg build
        # env:
          # CFLAGS: "-D_GNU_SOURCE"

      # 设置环境变量
      - name: Set environment variables
        run: |
          echo "TECTONIC_PKGCONFIG_FORCE_SEMI_STATIC=1" >> $GITHUB_ENV
          if [ "${{ matrix.platform.os }}" == "windows-latest" ]; then
            echo "TECTONIC_DEP_BACKEND=vcpkg" >> $GITHUB_ENV
            echo "VCPKGRS_TRIPLET=x64-windows-static-release" >> $GITHUB_ENV
            echo "RUSTFLAGS=-Ctarget-feature=+crt-static" >> $GITHUB_ENV
          fi

      # Linux 特定配置：设置 OpenSSL 环境
      # - name: Configure OpenSSL for Linux
      #   if: matrix.platform.os == 'ubuntu-20.04'
      #   run: |
      #     export OPENSSL_DIR=$(pkg-config --variable=prefix openssl)
      #     echo "OPENSSL_DIR=$OPENSSL_DIR" >> $GITHUB_ENV
      #     echo 'CFLAGS=-fPIC' >> $GITHUB_ENV
      #     echo 'CXXFLAGS=-fPIC' >> $GITHUB_ENV

      # 编译项目
      - name: Build project
        run: |
          cargo build --release --target ${{ matrix.platform.target }}

      # 下载 pdfium
      - name: Download pdfium
        run: |
          curl -L -o pdfium.tgz "${{ matrix.platform.pdfium_url }}"
          mkdir -p pdfium
          tar -xzf pdfium.tgz -C pdfium

      # 准备产物
      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          # 复制可执行文件和库
          if [ "${{ matrix.platform.os }}" == "windows-latest" ]; then
            cp target/${{ matrix.platform.target }}/release/tex2img.exe artifacts/
            cp target/${{ matrix.platform.target }}/release/libtex2img.dll artifacts/
          else
            cp target/${{ matrix.platform.target }}/release/tex2img artifacts/
            cp target/${{ matrix.platform.target }}/release/liblibtex2img.so artifacts/libtex2img.so
          fi
          # 复制 pdfium 动态库
          cp pdfium/${{ matrix.platform.pdfium_lib }} artifacts/
          # 复制 test_lib.py
          cp test_lib.py artifacts/
          # 创建压缩包
          cd artifacts
          if [ "${{ matrix.platform.os }}" == "windows-latest" ]; then
            zip -r ../${{ matrix.platform.artifact_name }}.zip .
          else
            tar -czf ../${{ matrix.platform.artifact_name }}.tar.gz .
          fi

      # 上传产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact_name }}
          path: ${{ matrix.platform.artifact_name }}.*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
    steps:
      # 检出代码以获取元数据
      - name: Checkout repository
        uses: actions/checkout@v4

      # 下载所有产物
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 创建 release draft
      - name: Create release draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=$(date -u +%Y%m%d%H%M%S)
          gh release create "$TAG_NAME" \
            --draft \
            --title "Release $TAG_NAME" \
            --notes "Automated release for multi-platform build" \
            artifacts/*/*